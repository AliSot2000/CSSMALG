# Simulation
## Table of Contents

1. [Include Directory](#include)
2. [Scripts Directory](#scripts)
3. [Specification directory](#specs)
4. [Source Directory](#src)
5. [Hints for HPC Cluster](#running-on-racklette)

## include
Header files of the files that are shared among the executables in the simulation.

## scripts
A bunch of python scripts used during the development of the simulation. Some are used for debugging, some are used 
for statistics and some are for file generation.

## specs
Contains a bunch of markdown files that describe the file format in which data has to be passed into and out of the 
simulation.

## src
Contains the source c++ and cuda code of the simulation.

## Compiling and running
To build the code yourself, you need cmake 3.23 or higher, make and a c++ compiler. The code was tested with gcc 9.4.0 on ubuntu 20.04.

In CSSMALG/code/Simulation, create a directory where you build the executables, say 'build'
```bash
cd CSSMALG/code/Simulation
mkdir build
cd build
```

Here you run the cmake command to generate the make files.
```bash
cmake .. # if you want to debug the code use option -DCMAKE_BUILD_TYPE="Debug", if you want to have the code run as fast as possible use option -DCMAKE_BUILD_TYPE="Release"
make # compiles the code with the make file generated by cmake
```

You should now be able to run the executables in the build directory. The executables are Visualize, Simulate, GenerateAgents and PrecalcSPT

### Trouble shooting
If you get an error related to a `fastFW.cu` file, this means you don't have the NVIDIA CUDA toolkit installed. This is used for the Floyd Warshall Algorithm
You can circumvent this issue by going into the routing.hpp file in the include directory and comment the #define USE_CUDA line. This will make the code use a slower implementation of the algorithm.
Additionally, you need to go into the CMakeLists.txt file and in the `add_executable` commands, remove the `src/fastFW.cu` files from the list.

If you get an error related to nvcc and unknown option -fopenmp, go to the CMakelists.txt file and comment the lines which say:
```cmake
target_compile_options(Simulate PUBLIC ${OpenMP_CXX_FLAGS})
target_link_libraries(Simulate PRIVATE ${OpenMP_CXX_LIBRARIES})
```
This should resolve the issue but remove the parallelization of the simulation.

### Code options [WIP, as not set via cmake but by hand]
- `USE_CUDA` - use the CUDA implementation of the Floyd Warshall algorithm, in the `include/routing.hpp` file
- `CUDA_SCALAR` - Multiplies the number of threads to use on a gpu, if it is set to 1, 1024 threads used, in the `src/fastFW.cu` file
- `DDEBUG` - Enables debug output, present in the `src/Simulate.cpp, src/Visualize.cpp, src/PrecalculateSPT.cpp, src/GenerateAgents.cpp` files
- `SLURM_OUTPUT` - Changes output of the files to more readable when captured by the slurm out files. Present in the `src/Simulate.cpp, src/PrecalculateSPT.cpp` files
- `USE_STUPID_INTERSECTIONS` - Uses a stupid algorithm to calculate intersections, present in the `src/imulate.cpp, src/Visualize.cpp` files
- `STATUS_UPDATAE_INTERVAL` - Sets at which interval a 'X Seconds to simulate' message is printed, present in the `src/Simulate.cpp, src/Visualize.cpp` files
- `DO_TRAFFIC_SIGNALS` - Enables traffic signals, present in the `src/Simulate.cpp, src/Visualize.cpp` files
- `ALTFW` - Enables alternative weight for Floyd Warshall Algorithm. Using len / (lane * speedlimit) instead of only the length of a road, in the `include/routing.hpp` file

### Running on Racklette
Required modules: slurm, cudatoolkit, cmake, gcc

Commands to run:
```bash
export OMP_PROC_BIND=true
export OMP_PLACES=threads
export OMP_NUM_THREADS=64 # or 32
```